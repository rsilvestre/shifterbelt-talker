{"version":3,"sources":["../src/ShifterbeltClient.es6"],"names":[],"mappings":"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","file":"ShifterbeltClient.js","sourcesContent":["/**\n * Created by michaelsilvestre on 25/04/15\n */\n\nimport events from \"events\"\nimport socketClient from 'socket.io-client'\nimport getmac from 'getmac'\nimport ValidateOptions from './lib/ValidateOptions'\nimport AnalyseMessage from './lib/analyse/AnalyseMessage'\nimport DeviceRole from './lib/DeviceRole'\nimport { _extend } from 'util'\n\nexport default class ShifterbeltClient {\n\n  /**\n   *\n   * @param {Object} options\n   */\n  constructor(options) {\n    this._messageInternalOut = new events.EventEmitter();\n    this._messageOut = new events.EventEmitter();\n    this._messageIn = new events.EventEmitter();\n\n    this._analyseMessage = {};\n    this._deviceRole = {};\n\n    // Setted dynamically\n    //this._masters = {};\n    //this._managers = {};\n    this._slaves = {};\n\n    options = _extend({ url: \"http://socket.shifterbelt.com/ns\" }, options);\n\n    getmac.getMac((err, macAddress) => {\n      options.macAddress = options.macAddress || macAddress; // TODO : Remove: \"options.macAddress ||\"\n      this.init(options);\n    });\n  }\n\n  /**\n   *\n   * @param {Object} options\n   */\n  init(options) {\n\n    let valid = (new ValidateOptions(options)).execute();\n\n    if (valid.err) {\n      return console.log(valid.err.message);\n    }\n\n    this._socket = socketClient(valid.result.url, { query: valid.result.options });\n\n    this._socket.on('connect', () => {\n      process.once('SIGINT', () => {\n        this._socket.emit('service', 'disconnect');\n        this._socket.close();\n        setTimeout(() => {\n          console.log('Thank you and see you later');\n          process.exit(0);\n        }, 1000);\n      });\n      this._socket.on('error_system', (message) => {\n        this._messageInternalOut.emit('error', message);\n      });\n\n      this._socket.emit('authenticate', JSON.stringify(valid.result.raw));\n\n      this._socket.on('authenticated', () => {\n        this._authenticated();\n      });\n    });\n\n    this._socket.on('disconnect', () => {\n      console.log('The connection with the sever has been lost...');\n      this._deviceRole.isConnected = false;\n    });\n  }\n\n  /**\n   *\n   * @private\n   */\n  _authenticated() {\n    this._analyseMessage = new AnalyseMessage(this, (deviceRole) => {\n      this._deviceRole = deviceRole.device;\n\n      this._messageInternalOut.emit('connect', this._deviceRole);\n    });\n\n    this._socket.on('message', (message) => {\n      this._internalOnMessage(message);\n    });\n\n    this._socket.on('service', (message) => {\n      this._internelOnService(message);\n    });\n\n    this._messageOut.addListener('send', (...data) => {\n      if (data.length === 1) {\n        return this._socket.emit('message', data[0]);\n      }\n\n      this._socket.emit('message', JSON.stringify({\n        key: data[0],\n        message: data[1]\n      }));\n\n    });\n\n  }\n\n  /**\n   *\n   * @param {Object} message\n   * @private\n   */\n  _internalOnMessage(message) {\n\n    if (message.hasOwnProperty('content')) {\n      let result = JSON.parse(message.content.toString());\n\n      if (result.hasOwnProperty('slaveId')) {\n        //return this._messageIn.emit(result['key'], result['slaveId'], result['value']);\n        return this._messageIn.emit(result['slaveId'], { key: result['key'], value: result['value'] });\n      } else {\n        return this._messageIn.emit(result['key'], result['value']);\n      }\n    }\n\n    var keys = Object.keys(message);\n    if (keys.length !== 1) {\n      return;\n    }\n    this._messageIn.emit(keys[0], message[keys[0]]);\n  }\n\n  /**\n   *\n   * @param {{}} message\n   * @private\n   */\n  _internelOnService(message) {\n    this._analyseMessage.execute(message);\n  }\n\n  /**\n   *\n   * @param {String} event\n   * @param {Function} callback\n   */\n  on(event, callback) {\n    this._messageInternalOut.addListener(event, callback);\n  }\n\n}"]}